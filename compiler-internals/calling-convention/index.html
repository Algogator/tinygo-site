<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.52" />
    <meta name="description" content="">


    <link rel="shortcut icon" href="/tinygo-site/images/favicon.png" type="image/x-icon" />
<link rel="icon" href="/tinygo-site/images/favicon.png" type="image/x-icon" />
    <title>Calling convention :: TinyGo</title>

    
    <link href="/tinygo-site/css/nucleus.css?1545167733" rel="stylesheet">
    <link href="/tinygo-site/css/fontawesome-all.min.css?1545167733" rel="stylesheet">
    <link href="/tinygo-site/css/hybrid.css?1545167733" rel="stylesheet">
    <link href="/tinygo-site/css/featherlight.min.css?1545167733" rel="stylesheet">
    <link href="/tinygo-site/css/perfect-scrollbar.min.css?1545167733" rel="stylesheet">
    <link href="/tinygo-site/css/auto-complete.css?1545167733" rel="stylesheet">
    <link href="/tinygo-site/css/theme.css?1545167733" rel="stylesheet">
    <link href="/tinygo-site/css/hugo-theme.css?1545167733" rel="stylesheet">
    
      <link href="/tinygo-site/css/theme-blue.css?1545167733" rel="stylesheet">
    

    <script src="/tinygo-site/js/jquery-2.x.min.js?1545167733"></script>

    <style type="text/css">
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    
  </head>
  <body class="" data-url="/tinygo-site/compiler-internals/calling-convention/">
    <nav id="sidebar" class="">



  <div id="header-wrapper">
    <div id="header">
      <html>
<a href="https://tinygo.org"><img src="https://tinygo-org.github.io/tinygo-site/images/tinygo-logo.png">
<h4 style="color:white; margin:0;">Go compiler for small places</h4></a>
</html>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="text" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-close"></i></span>
</div>

<script type="text/javascript" src="/tinygo-site/js/lunr.min.js?1545167733"></script>
<script type="text/javascript" src="/tinygo-site/js/auto-complete.js?1545167733"></script>
<script type="text/javascript">
    
        var baseurl = "https:\/\/tinygo-org.github.io\/tinygo-site\/";
    
</script>
<script type="text/javascript" src="/tinygo-site/js/search.js?1545167733"></script>

    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          


 
  
    
    <li data-nav-id="/tinygo-site/getting-started/" title="Getting Started" class="dd-item 
        
        
        
        ">
      <a href="/tinygo-site/getting-started/">
          Getting Started
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/tinygo-site/getting-started/requirements/" title="Requirements" class="dd-item ">
        <a href="/tinygo-site/getting-started/requirements/">
        Requirements
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/tinygo-site/getting-started/installation/" title="Installation" class="dd-item ">
        <a href="/tinygo-site/getting-started/installation/">
        Installation
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/tinygo-site/getting-started/usage/" title="Usage" class="dd-item ">
        <a href="/tinygo-site/getting-started/usage/">
        Usage
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/tinygo-site/usage/" title="Using TinyGo" class="dd-item 
        
        
        
        ">
      <a href="/tinygo-site/usage/">
          Using TinyGo
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/tinygo-site/usage/subcommands/" title="Subcommands" class="dd-item ">
        <a href="/tinygo-site/usage/subcommands/">
        Subcommands
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/tinygo-site/usage/important-options/" title="Important Build Options" class="dd-item ">
        <a href="/tinygo-site/usage/important-options/">
        Important Build Options
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/tinygo-site/usage/misc-options/" title="Misc. Build Options" class="dd-item ">
        <a href="/tinygo-site/usage/misc-options/">
        Misc. Build Options
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/tinygo-site/docker/" title="Using With Docker" class="dd-item 
        
        
        
        ">
      <a href="/tinygo-site/docker/">
          Using With Docker
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/tinygo-site/docker/using/" title="Using TinyGo with Docker" class="dd-item ">
        <a href="/tinygo-site/docker/using/">
        Using TinyGo with Docker
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/tinygo-site/compiler-internals/" title="Compiler Internals" class="dd-item 
        parent
        
        
        ">
      <a href="/tinygo-site/compiler-internals/">
          Compiler Internals
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/tinygo-site/compiler-internals/differences-from-go/" title="Differences from Go" class="dd-item ">
        <a href="/tinygo-site/compiler-internals/differences-from-go/">
        Differences from Go
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/tinygo-site/compiler-internals/datatypes/" title="Datatypes" class="dd-item ">
        <a href="/tinygo-site/compiler-internals/datatypes/">
        Datatypes
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/tinygo-site/compiler-internals/calling-convention/" title="Calling convention" class="dd-item active">
        <a href="/tinygo-site/compiler-internals/calling-convention/">
        Calling convention
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/tinygo-site/compiler-internals/pipeline/" title="Pipeline" class="dd-item ">
        <a href="/tinygo-site/compiler-internals/pipeline/">
        Pipeline
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
         
    </ul>

    
    

    
    <section id="footer">
      <center style="margin-top: -50px">Please give TinyGo a star!
    <p></p>
    <a class="github-button" href="https://github.com/aykevl/tinygo" data-icon="octicon-star" data-show-count="true" aria-label="Star TinyGo on GitHub">Star</a>
    <a class="github-button" href="https://github.com/aykevl/tinygo/fork" data-icon="octicon-repo-forked" data-show-count="true" aria-label="Fork TinyGo on GitHub">Fork</a>
    <p></p>
    <p>Site built with <a href="http://gohugo.io/">Hugo</a></p>
</center>

<script async defer src="https://buttons.github.io/buttons.js"></script>
    </section>
  </div>
</nav>





        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            <a href='/tinygo-site/'>Home</a> > <a href='/tinygo-site/compiler-internals/'>Compiler Internals</a> > Calling convention
          
         
          
         
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">

    </div>
</div>

                
              </div>
            </div>
            

        
        <div id="body-inner">
          
            <h1>Calling convention</h1>
          

        


<p>Go uses a stack-based calling convention and passes a pointer to the argument list as the first argument in the function. There were/are <a href="https://github.com/golang/go/issues/18597">plans to switch to a register-based calling convention</a> but they&rsquo;re now on hold.</p>

<p>TinyGo, however, uses a register based calling convention. In fact it is somewhat compatible with the C calling convention but with a few quirks:</p>

<ul>
<li>Struct parameters are split into separate arguments, if the number of fields (after flattening recursively) is 3 or lower. This is similar to the <a href="https://github.com/apple/swift/blob/master/docs/CallingConvention.rst#physical-conventions">Swift calling convention</a>. In the case of TinyGo, the size of each field does not matter, a field can even be an array:</li>
</ul>

<pre><code>{i8*, i32}           -&gt; i8*, i32
{{i8*, i32}, i16}    -&gt; i8*, i32, i16
{{i64}}              -&gt; i64
{}                   -&gt;
{i8*, i32, i8, i8}   -&gt; {i8*, i32, i8, i8}
{{i8*, i32, i8}, i8} -&gt; {i8*, i32, i8, i8}
</code></pre>

<p>Note that all native Go data types that are lowered to aggregate types in LLVM are expanded this way: <code>string</code>, slices, interfaces, and fat function pointers. This avoids some overhead in the C calling convention and makes the work of the LLVM optimizers easier.</p>

<ul>
<li>The WebAssembly target never exports or imports a <code>i64</code> (<code>int64</code>, <code>uint64</code>) parameter. Instead, it replaces them with <code>i64*</code>, allocating the value on the stack. In other words, imported functions are called with a 64-bit integer on the stack and exported functions must be called with a pointer to a 64-bit integer somewhere in linear memory.</li>
</ul>

<p>This is a workaround for a limitation in JavaScript, which only deals with doubles and can therefore only work with integers up to 32-bit in size (a 64-bit integer cannot be represented exactly in a double, a 32-bit integer can). It is expected that 64-bit integers will be <a href="https://github.com/WebAssembly/design/issues/1172">added in the near future</a> at which point this calling convention workaround may be removed. Also see <a href="https://github.com/rustwasm/wasm-bindgen/issues/35">this wasm-bindgen issue</a>.</p>

<ul>
<li>The WebAssembly target does not return variables directly that cannot be handled by JavaScript (<code>struct</code>, <code>i64</code>, multiple return values, etc). Instead, they are stored into a pointer passed as the first parameter by the caller.</li>
</ul>

<p>This is the calling convention as implemented by LLVM, with the extension that <code>i64</code> return values are returned in the same way as aggregate types.</p>

<ul>
<li>Blocking functions have a coroutine pointer prepended to the argument list, see <a href="https://github.com/aykevl/tinygo/blob/master/src/runtime/scheduler.go">src/runtime/scheduler.go</a> for details. Whether a function is blocking is determined by the AnalyseBlockingRecursive pass.</li>
</ul>

<p>This calling convention may change in the future. Changes will be documented here. However, even though it may change, it is expected that function signatures that only contain integers and pointers will remain stable.</p>


<footer class=" footline" >
	
</footer>


        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
        
        


	 
	 
		
			<a class="nav nav-prev" href="/tinygo-site/compiler-internals/datatypes/" title="Datatypes"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="/tinygo-site/compiler-internals/pipeline/" title="Pipeline" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/tinygo-site/js/clipboard.min.js?1545167733"></script>
    <script src="/tinygo-site/js/perfect-scrollbar.min.js?1545167733"></script>
    <script src="/tinygo-site/js/perfect-scrollbar.jquery.min.js?1545167733"></script>
    <script src="/tinygo-site/js/jquery.sticky.js?1545167733"></script>
    <script src="/tinygo-site/js/featherlight.min.js?1545167733"></script>
    <script src="/tinygo-site/js/html5shiv-printshiv.min.js?1545167733"></script>
    <script src="/tinygo-site/js/highlight.pack.js?1545167733"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/tinygo-site/js/modernizr.custom.71422.js?1545167733"></script>
    <script src="/tinygo-site/js/learn.js?1545167733"></script>
    <script src="/tinygo-site/js/hugo-learn.js?1545167733"></script>

    <link href="/tinygo-site/mermaid/mermaid.css?1545167733" type="text/css" rel="stylesheet" />
    <script src="/tinygo-site/mermaid/mermaid.js?1545167733"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    

  </body>
</html>

